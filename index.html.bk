<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ads Recommender — Find Local Deals</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#4f46e5;--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,Helvetica,Arial}
    body{background:linear-gradient(180deg,#071029 0%, #071a2a 100%);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:28px}
    .container{width:100%;max-width:980px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    form.controls{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=number],select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:var(--glass);color:inherit;box-sizing:border-box}
    .coords{display:flex;gap:8px;flex-wrap:wrap}
    .coord-item{flex:1 1 220px;min-width:140px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .results{margin-top:16px;display:grid;gap:12px}
    .ad{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column}
    .ad h3{margin:0 0 6px 0;font-size:15px}
    .ad p{margin:0;color:var(--muted);font-size:13px}
    .ad a{margin-top:8px;color:#a6c1ff;font-size:13px;text-decoration:none}
    .meta{font-size:12px;color:var(--muted);margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .footer{margin-top:12px;color:var(--muted);font-size:12px}
    @media(max-width:720px){
      header{gap:10px}
      .logo{width:44px;height:44px}
      form.controls{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">AD</div>
      <div>
        <h1>Ads Recommender</h1>
        <p class="lead">Enter coordinates or use your browser location, choose your interest, and get top 5 local ads.</p>
      </div>
    </header>

    <div class="card">
      <form id="searchForm" class="controls" onsubmit="return false;">
        <div style="grid-column:1/-1">
          <label for="interest">Your interest</label>
          <input id="interest" type="text" placeholder="e.g. electronics, food, fashion" required />
        </div>

        <div class="coords" style="grid-column:1/-1">
          <div class="coord-item">
            <label for="lat">Latitude</label>
            <input id="lat" type="text" inputmode="decimal" placeholder="e.g. 28.4595" />
          </div>
          <div class="coord-item">
            <label for="lon">Longitude</label>
            <input id="lon" type="text" inputmode="decimal" placeholder="e.g. 77.0266" />
          </div>
        </div>

        <div style="grid-column:1/-1;display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center">
          <button id="useLoc" class="secondary" type="button">Use my location</button>
          <button id="searchBtn" type="button">Find Ads</button>
          <button id="clearBtn" type="button" class="secondary">Clear</button>
          <div style="margin-left:auto" class="small" id="helpText">Tip: Allow browser to access location for autofill</div>
        </div>
      </form>

      <div id="status" class="small" style="margin-top:12px">Ready.</div>

      <div id="results" class="results" style="margin-top:12px"></div>

      <div class="footer">Results are fetched from the server endpoint <code>/ads/recommend</code>. The page prevents overlapping inputs on small screens.</div>
    </div>
  </div>

  <script>
    const latInput = document.getElementById('lat');
    const lonInput = document.getElementById('lon');
    const interestInput = document.getElementById('interest');
    const useLocBtn = document.getElementById('useLoc');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const status = document.getElementById('status');
    const results = document.getElementById('results');

    function setStatus(txt){ status.textContent = txt; }

    useLocBtn.addEventListener('click', () => {
      if (!navigator.geolocation) return setStatus('Geolocation not supported by your browser');
      setStatus('Getting your location…');
      navigator.geolocation.getCurrentPosition((pos) => {
        latInput.value = pos.coords.latitude.toFixed(6);
        lonInput.value = pos.coords.longitude.toFixed(6);
        setStatus('Location filled — press "Find Ads"');
      }, (err) => {
        setStatus('Could not get location: ' + err.message);
      }, {timeout:10000});
    });

    clearBtn.addEventListener('click', ()=>{
      latInput.value = '';
      lonInput.value = '';
      results.innerHTML = '';
      setStatus('Cleared');
    });

    searchBtn.addEventListener('click', async () => {
      const lat = latInput.value.trim();
      const lon = lonInput.value.trim();
      const interest = interestInput.value;
      if (!lat || !lon) { setStatus('Please enter latitude and longitude or use location'); return; }

      results.innerHTML = '';
      setStatus('Fetching POIs and ads…');

      try {
        const url = `/ads/recommend?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&interest=${encodeURIComponent(interest)}`;
        const resp = await fetch(url);
        if (!resp.ok) {
          const txt = await resp.text();
          setStatus('Server error: ' + resp.status + ' ' + txt);
          return;
        }
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
          setStatus('No ads found for this location/interest');
          return;
        }

        setStatus('Showing top ' + data.length + ' ads');
        data.forEach(ad => {
          const el = document.createElement('div'); el.className = 'ad';
          const h = document.createElement('h3'); h.textContent = ad.title || 'Untitled';
          const p = document.createElement('p'); p.textContent = ad.ad_text || '';
          const a = document.createElement('a'); a.href = ad.source_link || '#'; a.target = '_blank'; a.rel='noopener'; a.textContent = ad.source_link ? 'Source' : '';
          el.appendChild(h); el.appendChild(p); if (ad.source_link) el.appendChild(a);
          results.appendChild(el);
        });
      } catch (e) {
        setStatus('Fetch failed: ' + (e.message || e));
      }
    });

    // keyboard: press Enter in lon to submit
    lonInput.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') searchBtn.click(); });
  </script>
</body>
</html>
