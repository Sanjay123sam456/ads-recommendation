<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ads Recommender</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f1419;color:#e6eef8;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .header{background:#1a1f2e;padding:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4);margin-bottom:24px;display:flex;align-items:center;gap:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:24px;color:#fff}
    h1{font-size:28px;font-weight:700;color:#fff}
    .subtitle{font-size:14px;color:#9ba3af;margin-top:4px}
    .tabs{background:#1a1f2e;padding:20px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4);margin-bottom:20px}
    .tabs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px}
    .tab{background:#0f1419;border:2px solid rgba(255,255,255,0.1);padding:14px;border-radius:12px;cursor:pointer;transition:all 0.3s;text-align:center;font-weight:600;font-size:14px;color:#9ba3af}
    .tab:hover{background:#252a3a;border-color:#667eea}
    .tab.active{background:#667eea;border-color:#667eea;color:#fff;box-shadow:0 4px 12px rgba(102,126,234,0.5)}
    .tab-icon{font-size:28px;display:block;margin-bottom:8px}
    .search-box{display:flex;gap:12px;align-items:center}
    .search-input{flex:1;padding:12px 16px;background:#0f1419;border:2px solid rgba(255,255,255,0.1);border-radius:10px;font-size:15px;color:#fff;transition:all 0.3s}
    .search-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.2)}
    .controls{background:#1a1f2e;padding:20px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4);margin-bottom:20px}
    .coord-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    .btn-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:12px 24px;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.3s}
    .btn-primary{background:#667eea;color:#fff}
    .btn-primary:hover{background:#5a67d8;transform:translateY(-2px);box-shadow:0 4px 12px rgba(102,126,234,0.6)}
    .btn-primary:disabled{background:#4a4a5e;cursor:not-allowed;transform:none}
    .btn-secondary{background:transparent;border:2px solid rgba(255,255,255,0.2);color:#9ba3af}
    .btn-secondary:hover{border-color:#667eea;color:#fff}
    .main-grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
    #map{height:580px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1)}
    .sidebar{display:flex;flex-direction:column;gap:20px}
    .panel{background:#1a1f2e;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.4);padding:20px}
    .panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid rgba(255,255,255,0.05)}
    .panel-title{font-size:18px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px}
    .panel-content{max-height:460px;overflow-y:auto}
    .ad-card{background:#0f1419;padding:16px;border-radius:12px;margin-bottom:12px;border:2px solid rgba(255,255,255,0.05);transition:all 0.3s;position:relative}
    .ad-card:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,0.2)}
    .ad-card h3{font-size:15px;font-weight:600;margin-bottom:8px;color:#fff;padding-right:32px}
    .ad-card p{font-size:13px;color:#9ba3af;margin-bottom:10px;line-height:1.5}
    .ad-footer{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ad-link{color:#667eea;font-size:13px;text-decoration:none;font-weight:600}
    .ad-link:hover{text-decoration:underline;color:#5a67d8}
    .badge{background:rgba(102,126,234,0.2);color:#a5b4fc;padding:5px 10px;border-radius:8px;font-size:11px;font-weight:600}
    .fav-btn{position:absolute;top:12px;right:12px;background:transparent;border:none;cursor:pointer;font-size:20px;transition:transform 0.2s}
    .fav-btn:hover{transform:scale(1.2)}
    .status-bar{font-size:13px;color:#9ba3af;padding:8px 16px;background:#0f1419;border-radius:8px;border:1px solid rgba(255,255,255,0.1)}
    .empty{text-align:center;padding:60px 20px;color:#718096}
    .banner{background:#3b2a12;color:#ffd27f;padding:12px;border-radius:10px;margin-bottom:20px;font-size:14px;text-align:center;font-weight:600}
    @media(max-width:1024px){.main-grid{grid-template-columns:1fr}#map{height:400px}}
    @media(max-width:640px){.tabs-grid{grid-template-columns:repeat(2,1fr)}.coord-row{grid-template-columns:1fr}}
    ::-webkit-scrollbar{width:8px}
    ::-webkit-scrollbar-track{background:#0f1419}
    ::-webkit-scrollbar-thumb{background:#667eea;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#5a67d8}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">AD</div>
      <div>
        <h1>Ads Recommender</h1>
        <div class="subtitle">Discover personalized local offers</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tabs-grid">
        <div class="tab active" data-interest="electronics"><span class="tab-icon">üì±</span>Electronics</div>
        <div class="tab" data-interest="food"><span class="tab-icon">üçî</span>Food</div>
        <div class="tab" data-interest="fashion"><span class="tab-icon">üëï</span>Fashion</div>
        <div class="tab" data-interest="pharmacy"><span class="tab-icon">üíä</span>Pharmacy</div>
        <div class="tab" data-interest="grocery"><span class="tab-icon">üõí</span>Grocery</div>
      </div>
      <div class="search-box">
        <input id="interestInput" class="search-input" type="text" placeholder="Or type your interest (e.g., books, gym, restaurants)"/>
      </div>
    </div>

    <div class="controls">
      <div class="coord-row">
        <input id="lat" class="search-input" type="number" step="any" placeholder="Latitude"/>
        <input id="lon" class="search-input" type="number" step="any" placeholder="Longitude"/>
      </div>
      <div class="btn-row">
        <button id="useLocBtn" class="btn-secondary">üìç Use My Location</button>
        <button id="searchBtn" class="btn-primary">üîç Find Ads</button>
        <button id="clearBtn" class="btn-secondary">Clear</button>
        <div id="status" class="status-bar">Ready</div>
      </div>
    </div>

    <div id="demoBanner" class="banner" style="display:none">‚ö†Ô∏è Demo ads shown - API quota exhausted</div>

    <div class="main-grid">
      <div><div id="map"></div></div>
      <div class="sidebar">
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">üì¢ Nearby Ads <span id="adCount" style="font-size:13px;color:#718096;font-weight:400"></span></div>
          </div>
          <div class="panel-content" id="adsList">
            <div class="empty">Select a category and location to discover ads</div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">‚≠ê Favorites</div>
            <button id="clearFavsBtn" class="btn-secondary" style="padding:6px 14px;font-size:12px">Clear</button>
          </div>
          <div class="panel-content" id="favsList">
            <div class="empty">No favorites saved</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let selectedInterest='electronics',favorites=JSON.parse(localStorage.getItem('adFavorites')||'[]'),currentAds=[];
    const map=L.map('map').setView([28.6139,77.2090],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
    let markersLayer=L.layerGroup().addTo(map),userMarker=null;
    const tabs=document.querySelectorAll('.tab'),latInput=document.getElementById('lat'),lonInput=document.getElementById('lon'),interestInput=document.getElementById('interestInput'),useLocBtn=document.getElementById('useLocBtn'),searchBtn=document.getElementById('searchBtn'),clearBtn=document.getElementById('clearBtn'),clearFavsBtn=document.getElementById('clearFavsBtn'),status=document.getElementById('status'),adsList=document.getElementById('adsList'),favsList=document.getElementById('favsList'),adCount=document.getElementById('adCount'),demoBanner=document.getElementById('demoBanner');
    
    tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');selectedInterest=t.dataset.interest;interestInput.value='';}));
    
    useLocBtn.addEventListener('click',()=>{if(!navigator.geolocation)return setStatus('Not supported');setStatus('Getting location...');useLocBtn.disabled=true;navigator.geolocation.getCurrentPosition(p=>{const lat=p.coords.latitude.toFixed(6),lon=p.coords.longitude.toFixed(6);latInput.value=lat;lonInput.value=lon;map.setView([lat,lon],14);if(userMarker)map.removeLayer(userMarker);userMarker=L.marker([lat,lon]).addTo(map).bindPopup('üìç You are here').openPopup();setStatus('Location set');useLocBtn.disabled=false;},e=>{setStatus('Location error');useLocBtn.disabled=false;},{timeout:10000});});
    
    searchBtn.addEventListener('click',async()=>{const lat=parseFloat(latInput.value),lon=parseFloat(lonInput.value),interest=interestInput.value.trim()||selectedInterest;if(isNaN(lat)||isNaN(lon))return setStatus('Invalid coordinates');if(lat<-90||lat>90||lon<-180||lon>180)return setStatus('Out of range');await fetchAds(lat,lon,interest);});
    
    clearBtn.addEventListener('click',()=>{latInput.value='';lonInput.value='';interestInput.value='';adsList.innerHTML='<div class="empty">Select a category and location to discover ads</div>';markersLayer.clearLayers();if(userMarker)map.removeLayer(userMarker);demoBanner.style.display='none';adCount.textContent='';currentAds=[];setStatus('Cleared');});
    
    clearFavsBtn.addEventListener('click',()=>{if(confirm('Clear all favorites?')){favorites=[];localStorage.setItem('adFavorites',JSON.stringify(favorites));renderFavorites();}});
    
    function setStatus(t){status.textContent=t;}
    
    async function fetchAds(lat,lon,interest){setStatus('Fetching...');searchBtn.disabled=true;searchBtn.textContent='‚è≥ Loading...';markersLayer.clearLayers();try{const r=await fetch(`/ads/recommend?lat=${lat}&lon=${lon}&interest=${encodeURIComponent(interest)}`);if(!r.ok)throw new Error('Server error');const ads=await r.json();currentAds=ads;demoBanner.style.display=ads.length>0&&ads.every(a=>(a.title||'').includes('Demo'))?'block':'none';renderAds(ads);addMarkersToMap(ads,lat,lon);setStatus(`Found ${ads.length} ads`);adCount.textContent=`(${ads.length})`;}catch(e){setStatus('Error: '+e.message);adsList.innerHTML='<div class="empty">Failed to load ads</div>';}finally{searchBtn.disabled=false;searchBtn.textContent='üîç Find Ads';}}
    
    function renderAds(ads){if(!ads.length){adsList.innerHTML='<div class="empty">No ads found</div>';return;}adsList.innerHTML=ads.map((a,i)=>{const isFav=favorites.some(f=>f.title===a.title&&f.source_link===a.source_link);return`<div class="ad-card"><button class="fav-btn" onclick="toggleFavorite(${i})">${isFav?'‚ù§Ô∏è':'ü§ç'}</button><h3>${escapeHtml(a.title||'Untitled')}</h3><p>${escapeHtml(a.ad_text||'')}</p><div class="ad-footer">${a.source_link?`<a class="ad-link" href="${escapeHtml(a.source_link)}" target="_blank" rel="noopener">View Offer</a>`:''}${a.lat&&a.lon?`<span class="badge">üìç ${a.lat.toFixed(4)}, ${a.lon.toFixed(4)}</span>`:'<span class="badge">üåê Online</span>'}</div></div>`;}).join('');}
    
    function addMarkersToMap(ads,userLat,userLon){let bounds=[];ads.forEach(a=>{if(a.lat&&a.lon){const m=L.marker([a.lat,a.lon]).addTo(markersLayer);m.bindPopup(`<strong>${escapeHtml(a.title)}</strong><br>${escapeHtml(a.ad_text||'')}`);bounds.push([a.lat,a.lon]);}});bounds.length>0?map.fitBounds(bounds,{padding:[50,50]}):map.setView([userLat,userLon],13);}
    
    function toggleFavorite(i){const a=currentAds[i],ei=favorites.findIndex(f=>f.title===a.title&&f.source_link===a.source_link);ei>=0?favorites.splice(ei,1):favorites.push(a);localStorage.setItem('adFavorites',JSON.stringify(favorites));renderAds(currentAds);renderFavorites();}
    
    function renderFavorites(){if(!favorites.length){favsList.innerHTML='<div class="empty">No favorites saved</div>';return;}favsList.innerHTML=favorites.map((a,i)=>`<div class="ad-card"><button class="fav-btn" onclick="removeFavorite(${i})">‚ùå</button><h3>${escapeHtml(a.title||'Untitled')}</h3><p>${escapeHtml(a.ad_text||'')}</p><div class="ad-footer">${a.source_link?`<a class="ad-link" href="${escapeHtml(a.source_link)}" target="_blank" rel="noopener">View</a>`:''}</div></div>`).join('');}
    
    function removeFavorite(i){favorites.splice(i,1);localStorage.setItem('adFavorites',JSON.stringify(favorites));renderFavorites();if(currentAds.length>0)renderAds(currentAds);}
    
    function escapeHtml(t){const div=document.createElement('div');div.textContent=t;return div.innerHTML;}
    
    window.toggleFavorite=toggleFavorite;window.removeFavorite=removeFavorite;renderFavorites();
  </script>
</body>
</html>